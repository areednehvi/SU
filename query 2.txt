USE [SchoolUniverse]
GO
/****** Object:  StoredProcedure [dbo].[GetStudentPaymentHistory]    Script Date: 10/1/2017 11:07:24 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		<Arif Nazir>
-- Create date: <Create Date,,>
-- Description:	<GetStudentPaymentHistory>
--				Get Specific rows based on FromRowNo and ToRowNo
-- =============================================
Create PROCEDURE [dbo].[GetStudentPaymentHistory] @FromRowNo nvarchar(200), @ToRowNo nvarchar(200), @StudentID bigint
AS
WITH StudentPaymentHistory AS 
        ( 
           SELECT
				ROW_NUMBER() OVER(order by s.id) AS 'RowNumber', 
				sp.*,
				u.full_name AS [student_name],
				f.id AS [fees_id],
				sf.student_id,
				sf.grade_fees_id,
				sf.concession_amount,
				rvsfl.route_vehicle_stop_id, 
				--DATE_FORMAT([sf.apply_from],'%b ') AS [month],
				sf.apply_from,
				sf.apply_to,
				f.amount AS [fee_amount],
				f.fee_category_id,
				fc.name AS [category_name]
			FROM
				student_payments AS sp
			LEFT JOIN student_fees AS sf ON sf.id = sp.student_fees_id
			LEFT JOIN students AS s ON s.id = sf.student_id
			LEFT JOIN users AS u ON u.id = s.user_id
			LEFT JOIN grade_fees AS gf ON gf.id = sf.grade_fees_id
			LEFT JOIN route_vehicle_stops_fee_logs AS rvsfl ON rvsfl.id = sf.route_vehicle_stops_fee_log_id
			LEFT JOIN route_vehicle_stops AS rvs ON rvs.id = rvsfl.route_vehicle_stop_id
			LEFT JOIN fees AS f ON f.id = gf.fees_id OR f.id = rvsfl.fees_id
			LEFT JOIN fee_categories AS fc ON fc.id = f.fee_category_id		
			WHERE s.id = @StudentID		
				) 
				SELECT 
					*
				FROM StudentPaymentHistory 
				WHERE RowNumber BETWEEN @FromRowNo AND @ToRowNo


				exec [GetStudentPaymentHistory] 1 ,200 ,2065










